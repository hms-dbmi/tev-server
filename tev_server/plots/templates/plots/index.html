<!DOCTYPE html>
<html lang="en" ng-app = "tevApp">
<head>
    <meta charset="UTF-8">
    <title>TEV</title>
</head>
<style>
    .axis path, .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }


</style>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.js"></script>
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<script>
    function uniqueAxisLabels(data, key) {
        var unique = {};
        var distinct = [];
        data.forEach(function (x) {
            if (!unique[x[key]]) {
                distinct.push(x[key]);
                unique[x[key]] = true;
            }
        });

        return distinct;
    }

    (function() {
        //Application name: tevApp
        //Dependencies: None
        var tevApp = angular.module('tevApp', []);

        //To distinguish between any Django references in the HTML
        tevApp.config(function($interpolateProvider) {
            $interpolateProvider.startSymbol('{$');
            $interpolateProvider.endSymbol('$}');
        });

        tevApp.factory('alleleify', function(){
            return {
                alleleify: function(data, gene_data){
                    var allele_data = [];

                    //Loop through to get all uuid
                    //So we only have to access, instead of loop through for every amino acid change
                    var gene_uuids = [];
                    for(var i = 0; i < gene_data.length; i++){
                        gene_uuids.push(gene_data[i].uuid);
                    }

                    for(var i = 0; i < data.length; i++){
                        var timepoint = data[i].timepoint;
                        var alleles = data[i].VariantAlleles;
                        for(var j = 0; j < alleles.length; j++){
                            var allele = gene_data[gene_uuids.indexOf(alleles[j].gene)].hugo_symbol
                                    + '-'
                                    + alleles[j].AA_original
                                    + alleles[j].AA_position.toString()
                                    + alleles[j].AA_variant;
                            var alt_count = alleles[j].alternative_freq;
                            allele_data.push({
                                allele: allele,
                                Sample_Barcode: timepoint,
                                alt_count: alt_count
                            });
                        }
                    }
                    return allele_data;
                }
            };
        });

        //Controller name: TevDataController
        //Services: scope, http
        tevApp.controller('tevDataController', ['$scope', '$http', '$filter', 'alleleify', '$q',
            function($scope, $http, $filter, allelify, $q){
            //Initialize the scopes data to empty (will render blank plots until we've fetched data)
                $scope.tevData = [];
                $scope.alleleified_data = [];
                $scope.nestedAlleleData = [];
                $scope.dendro_data = [];
                $scope.dendro_y_data = [];

                var source_uuid = '{{ source }}';
                var dendro_data = {{ d3_dendro_data|safe }};
                var dendro_y_data = {{ dendro_y_data }};

            //Get the data from the API
                var source_data = $http.get('http://127.0.0.1:8000/api/v1/sources/');
                var gene_data = $http.get('http://127.0.0.1:8000/api/v1/genes/');

                $q.all([source_data, gene_data]).then(function(results_array){
                    var gene_data = results_array[1].data;
                    console.log(gene_data);
                    var tevData = results_array[0].data;
                    tevData = $filter('filter')(tevData, {'uuid': source_uuid})[0];
                    $scope.tevData = tevData.Samples;

                    $scope.alleleified_data = allelify.alleleify($scope.tevData, gene_data);

                    //Send through this data, when the data from the API has been recieved
                    $scope.dendro_data = dendro_data;
                    $scope.dendro_y_data = dendro_y_data;
                });

        }]);

        //Directive that contains d3 code to render allele frequency change over timepoints
        //Plot type: Line plot
        tevApp.directive('figure1Plot', function(){
            return {
               scope: {
                   data: '='
               },
               restrict: 'A',
               link: link
           };

            function link(scope, element){
                var data = scope.data;
                var el = element[0];
                var width = el.clientWidth;
                var height = el.clientHeight;
                var strokeColors = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd",
                                    "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"];

                scope.$watch('data', function(updatedData){
                    d3.select(el).select('svg').remove();
                    data = updatedData;

                    var canvas = d3.select(el).append("svg")
                        .attr("height", height)
                        .attr("width", width);

                    var yScale = d3.scale.linear().range([40, 500]).domain([1, 0]);
                    var yAxis = d3.svg.axis().scale(yScale).orient("left");

                    var axisLabels = uniqueAxisLabels(data, 'Sample_Barcode');

                    var xScale = d3.scale.ordinal().rangePoints([40, 500], 0.5).domain(axisLabels);
                    var xAxis = d3.svg.axis().scale(xScale);

                    var lineGen = d3.svg.line()
                            .x(function(d){
                                return xScale(d.Sample_Barcode);
                            })
                            .y(function(d){
                                return yScale(d.alt_count/100);
                            });

                    var nestedData = d3.nest()
                            .key(function(d){
                               return d.allele;
                            })
                            .entries(data);

                    var lineSvg = canvas.append("g");
                    var pointSvg = canvas.append("g");

                    var index;

                    nestedData.forEach(function(d, i){

                        lineSvg.append("path")
                                .attr("fill", "none")
                                .attr("stroke", strokeColors[i])
                                .attr("stroke-width", 2)
                                .attr("d", lineGen(d.values));

                        pointSvg.selectAll("timepoints")
                                .data(d.values)
                                .enter()
                                .append("rect")
                                .attr("x", function(d){
                                    return (xScale(d.Sample_Barcode)-5);
                                })
                                .attr("y", function(d){
                                    return (yScale(d.alt_count/100) - 5);
                                })
                                .attr("width", 10)
                                .attr("height", 10)
                                .attr("fill", strokeColors[i]);
                    });


                    canvas.append("svg:g")
                        .attr("class", "axis")
                        .attr("transform", "translate(0," + 500 + ")")
                        .call(xAxis);

                    canvas.append("svg:g")
                        .attr("class", "axis")
                        .attr("transform", "translate(" + 4 + "0)")
                        .call(yAxis);

                }, true);
            }
        });

        //Directive that contains d3 code to render distribution of allele frequency at timepoints
        //Plot type: Box plots
        tevApp.directive('figure2Plot', function(){
            return{
                restrict: 'A',
                link: link,
                scope: {
                    data: '='
                }
            };

            function link(scope, element){
                var data = scope.data;
                var el = element[0];
                var width = el.clientWidth;
                var height = el.clientHeight;
                var fillColors = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd",
                                    "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"];


                scope.$watch('data', function(updatedData){
                    d3.select(el).select('svg').remove();

                    data = updatedData;

                    var canvas = d3.select(el).append("svg")
                        .attr("height", height)
                        .attr("width", width);

                    var yScale = d3.scale.linear().range([40, 500]).domain([1, 0]);
                    var yAxis = d3.svg.axis().scale(yScale).orient("left");

                    var axisLabels = uniqueAxisLabels(data, 'allele');
                    var xScale = d3.scale.ordinal().rangePoints([40, 500], 0.5).domain(axisLabels);
                    var xAxis = d3.svg.axis().scale(xScale);

                    var nestedData = d3.nest().key(function(d){return d.allele}).entries(data);

                    var boxData = [];
                    nestedData.forEach(function(d, i){
                        var quartileData = [];
                        for(var j = 0; j < d.values.length; j++){
                            quartileData[j] = d.values[j].alt_count/100;
                        }
                        quartileData.sort(function(a,b) { return a - b;});

                        boxData[i] = {
                            x: d.key,
                            y: d3.quantile(quartileData, 0.75),
                            Q3: d3.quantile(quartileData, 0.75),
                            Q1: d3.quantile(quartileData, 0.25),
                            median: d3.median(quartileData),
                            pNinety: d3.quantile(quartileData, 0.90),
                            pTen: d3.quantile(quartileData, 0.10),
                            color: fillColors[i]

                        };
                    });

                    //Start of d3 box plot

                    canvas.selectAll('boxes')
                            .data(boxData)
                            .enter()
                            .append('rect')
                            .attr('x', function(d){
                                return xScale(d.x) - 10;
                            })
                            .attr('y', function(d){
                                return yScale(d.Q3);
                            })
                            .attr('width', 20)
                            .attr('height', function(d){
                                return (yScale(d.Q1) - yScale(d.Q3));
                            })
                            .attr('fill', function(d){
                               return d.color;
                            });

                    canvas.selectAll('medianLines')
                            .data(boxData)
                            .enter()
                            .append('line')
                            .attr('x1', function(d){
                                return xScale(d.x) - 10;
                            })
                            .attr('x2', function(d){
                                return xScale(d.x) + 10;
                            })
                            .attr('y1', function(d){
                                return yScale(d.median);
                            })
                            .attr('y2', function(d){
                                return yScale(d.median);
                            })
                            .attr('stroke', 'black')
                            .attr('stroke-width', 1)
                            .attr('fill', 'none');

                    canvas.selectAll('upperVerticalBars')
                            .data(boxData)
                            .enter()
                            .append('line')
                            .attr('x1', function(d){
                                return xScale(d.x);
                            })
                            .attr('x2', function(d){
                                return xScale(d.x);
                            })
                            .attr('y1', function(d){
                                return yScale(d.pNinety);
                            })
                            .attr('y2', function(d){
                                return yScale(d.Q3);
                            })
                            .attr('fill', 'none')
                            .attr('stroke', 'black')
                            .attr('stroke-width', 1);


                    canvas.selectAll('lowerVerticalBars')
                            .data(boxData)
                            .enter()
                            .append('line')
                            .attr('x1', function(d){
                                return xScale(d.x);
                            })
                            .attr('x2', function(d){
                                return xScale(d.x);
                            })
                            .attr('y1', function(d){
                                return yScale(d.Q1);
                            })
                            .attr('y2', function(d){
                                return yScale(d.pTen);
                            })
                            .attr('stroke', 'black')
                            .attr('stroke-width', 1)
                            .attr('fill', 'none');

                    canvas.selectAll('pNinetyBars')
                            .data(boxData)
                            .enter()
                            .append('line')
                            .attr('x1', function(d){
                                return xScale(d.x) - 10;
                            })
                            .attr('x2', function(d){
                                return xScale(d.x) + 10;
                            })
                            .attr('y1', function(d){
                                return yScale(d.pNinety);
                            })
                            .attr('y2', function(d){
                                return yScale(d.pNinety);
                            })
                            .attr('stroke', 'black')
                            .attr('stroke-width', 1)
                            .attr('fill', 'none');

                    canvas.selectAll('pTenBars')
                            .data(boxData)
                            .enter()
                            .append('line')
                            .attr('x1', function(d){
                                return xScale(d.x) - 10;
                            })
                            .attr('x2', function(d){
                                return xScale(d.x) + 10;
                            })
                            .attr('y1', function(d){
                                return yScale(d.pTen);
                            })
                            .attr('y2', function(d){
                                return yScale(d.pTen);
                            })
                            .attr('stroke', 'black')
                            .attr('stroke-width', 1)
                            .attr('fill', 'none');


                    canvas.append("svg:g")
                        .attr("class", "axis")
                        .attr("transform", "translate(0," + 500 + ")")
                        .call(xAxis)
                            .selectAll("text")
                            .style('text-anchor', 'end')
                            .attr('transform', 'rotate(-65)');

                    canvas.append("svg:g")
                        .attr("class", "axis")
                        .attr("transform", "translate(" + 4 + "0)")
                        .call(yAxis);
                }, true);
            }
        });

        tevApp.directive('figure3Plot', function(){

            return {
               restrict: 'A',
               scope: {
                   data: '='
               },
               link: link
            };

            function link(scope, element){
                var data = scope.data[0];
                var dendro_y_positions = scope.data[1];
                var el = element[0];
                var width = el.clientWidth;
                var height = el.clientHeight;

                var cluster = d3.layout.cluster()
                        .size([420, 420]);

                scope.$watch('data', function(updatedData){
                    d3.select(el).select('svg').remove();
                    var canvas = d3.select(el).append('svg')
                            .attr('height', height)
                            .attr('width', width);

                    data = updatedData[0];
                    var dendro_y_positions = updatedData[1];
                    var fish_bone_data = updatedData[2];

                    var y_max = Math.max.apply(null, dendro_y_positions);
                    var yScale = d3.scale.linear().domain([y_max, 0]).range([30, 450]);
                    var yAxis = d3.svg.axis().scale(yScale).orient('top');

                    var nodes = cluster.nodes(data);
                    var links = cluster.links(nodes);

                    nodes.forEach(function(d, i){
                        d.y = dendro_y_positions[i];
                    });

                    var link = canvas.selectAll('.link')
                            .data(links)
                            .enter()
                            .append('path')
                            .attr('class', 'link')
                            .attr('d', function elbow(d, i) {
                                return "M" + yScale(d.source.y) + "," + d.source.x
                                        + "V" + d.target.x + "H" + yScale(d.target.y);
                            })
                            .attr('fill', 'none')
                            .attr('stroke', "#ccc")
                            .attr('stroke-width', 1.5)
                            .attr('transform', 'translate(0,40)');

                    var node = canvas.selectAll('.node')
                            .data(nodes)
                            .enter()
                            .append('g')
                            .attr('class', 'node')
                            .attr('transform', function(d){return "translate("+ yScale(d.y) + "," + (d.x + 40) + ")";});

                    node.append('circle')
                            .attr('r', 4.5);

                    node.append("text")
                            .attr("dx", function(d) { return d.children ? -8 : 8; })
                            .attr("dy", 3)
                            .attr("text-anchor", function(d) { return d.children ? "end" : "start"; })
                            .text(function(d) { return d.name; })
                            .attr('font-size', 'small');

                    canvas.append("svg:g")
                            .attr("class", "axis")
                            .attr('transform', 'translate(0, 25)')
                            .call(yAxis);

                });
            }

        }, true);

        tevApp.directive('figure4Plot', function(){
            return {
                restrict: 'A',
                scope: {
                    data: '='
                },
                link: link
            };

            function link(scope, element){
                var data = scope.data;
                var el =  element[0];
                var width = el.clientWidth;
                var height = el.clientHeight;

                var cluster = d3.layout.cluster()
                        .size([420, 420]);

                scope.$watch('data', function(updatedData){

                    data = updatedData;

                    var nodes = cluster.nodes(data);
                    var links = cluster.links(nodes);

                    var terminal_node_indices = [];

                    nodes.forEach(function(d, i){
                        if(d.children == undefined){
                            terminal_node_indices.push(i);
                        }
                    });


                    console.log(terminal_node_indices);

                });
            }

        });

        tevApp.directive('figure5Plot', function(){

            return {
                restrict: 'A',
                scope: {
                    data: '='
                },
                link: link
            };

            function link(scope, element){
                var data = scope.data;
                var el = element[0];
                var width = el.clientWidth;
                var height = el.clientHeight;

                var fillColors = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd",
                                    "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"];

                scope.$watch('data', function(updatedData){
                    d3.select(el).select('svg').remove();

                    data = updatedData;

                    var canvas = d3.select(el).append('svg')
                        .attr('width', width)
                        .attr('height', height);

                    var xAxisLabels = uniqueAxisLabels(data, 'Sample_Barcode');
                    xAxisLabels.unshift('origin');

                    var xScale = d3.scale.ordinal().rangePoints([40, 500], 0.5).domain(xAxisLabels);
                    var xAxis = d3.svg.axis().scale(xScale);

                    var yScale = d3.scale.linear().range([40, 500], 0.5).domain([50, -50]);
                    var yAxis = d3.svg.axis().scale(yScale).orient('left').ticks(0);

                    var nestedData = d3.nest().key(function(d){return d.allele}).entries(data);

                    //Dirty way of adding origin (tail fin of fish plot)
                    /*******************************************************************************/
                    /*Important to unshift, because order of making line matters for x values!!!!!*/
                    /*******************************************************************************/
                    for(var i = 0; i < nestedData.length; i++){
                        nestedData[i].values.unshift({
                           Sample_Barcode: 'origin',
                            alt_count: 0
                        });
                    }

                    var topLineGen = d3.svg.line()
                            .interpolate('basis')
                            .x(function(d){
                                return xScale(d.Sample_Barcode);
                            })
                            .y(function(d){
                               return yScale(d.alt_count/2);
                            });

                    var bottomLineGen = d3.svg.line()
                            .interpolate('basis')
                            .x(function(d){
                                return xScale(d.Sample_Barcode);
                            })
                            .y(function(d){
                               return yScale(-(d.alt_count/2));
                            });

                    //Get all of the x-values that make up the top line (will be same as bottom, symmetrical)
                    //Then take area along y-axis between the top and bottom lines
                    var areaBetweenLines = d3.svg.area()
                            .interpolate('basis')
                            .x(topLineGen.x())
                            .y0(topLineGen.y())
                            .y1(bottomLineGen.y());


                    nestedData.forEach(function(d, i){

                        canvas.append('path')
                                .attr('fill', 'none')
                                .attr('stroke', fillColors[i])
                                .attr('stroke-width', 1)
                                .attr('d', topLineGen(d.values));

                        canvas.append('path')
                                .attr('fill', 'none')
                                .attr('stroke', fillColors[i])
                                .attr('stroke-width', 1)
                                .attr('d', bottomLineGen(d.values));

                        canvas.append('path')
                                .attr('fill', 'none')
                                .attr('stroke', fillColors[i])
                                .attr('stroke-width', 1)
                                .attr('d', topLineGen(d.values));

                        canvas.append('path')
                                .datum(d.values)
                                .attr('fill', fillColors[i])
                                .attr('opacity', 0.75)
                                .attr('d', areaBetweenLines);
                    });


                    canvas.append("svg:g")
                        .attr("class", "axis")
                        .attr("transform", "translate(0," + 500 + ")")
                        .call(xAxis);

                    canvas.append("svg:g")
                        .attr("class", "axis")
                        .attr("transform", "translate(" + 4 + "0)")
                        .call(yAxis);

                });
            }

        }, true);

    })();

</script>
<body ng-controller = "tevDataController">

<div id="figure1" figure1-plot data="alleleified_data" style="width: 550px; height: 650px; float:left;">
</div>


<div id="figure2" figure2-plot data="alleleified_data" style="width: 550px; height: 650px; float: left;">
</div>

<div id="figure3" figure3-plot data="[dendro_data, dendro_y_data, fish_bone_data]"
     style="width: 550px; height: 650px; float: left;">
</div>

<!--
<div id="figure4" figure4-plot data="dendro_data" style="width: 550px; height: 650px; float: left;">
</div>
-->

<div id="figure5" figure5-plot data="alleleified_data" style="width: 550px; height: 650px; float: left;">
</div>

</body>
</html>